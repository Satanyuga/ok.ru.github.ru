define(["jquery","OK/logger","OK/utils/utils"],function(aC,U,ah){var aA,Z=null,X=null,ar="mtLayer",N="mtLayerMain",ai="mtLayerBack",aM="mtLayerForward",c="scrollToTopMtLayer",ao="media-layer js-viewport-container",j="media-layer_hld",ap="mlr_disc",af="media-layer_close",aE="media-layer_close_ico",ay="media-layer_close_ovr",d="sticky-plank_cnt",W="media-layer_fixer",Q="js_mediaLayerActions",al=310,i=null,F=null,w=null,p=null,b=null,v=null,aO=null,aP=null,o=null,aG=null,P=1145,D={id:null,to:75},M="MediaTopicLayerBody",aJ="MediaTopicLayerAd",k="AnonymMediaTopicLayerAd",n="layer__disabled",u="invisible",ae="data-banner-seq-show-count",f=false,aD,T,a=false,J,A=ah.deferred();function z(aU,aS){var aT=document.getElementById(aU),aR;if(!aT){return false;}for(aR=0;aR<aS.length;aR+=1){if(aT.classList.contains(aS[aR])){return false;}}return true;}function aa(){return aA.isActive&&!aC("#hook_Block_PopLayerMediaTopic").hasClass(n);}function t(){return aA.isActive&&aC("#hook_Block_PopLayerMediaTopic").hasClass(n);}function x(aR){if(aa()){if(!a&&i[0]!==document.activeElement&&i.find(document.activeElement).length===0){i.focus();a=true;}if(i.hasClass("__edit")||i.find(".__edit").length>0){return;}if(i.find(".tag-box__editable").length>0){return;}if(z("hook_Modal_popLayerModal",[n])){return;}if(z("photoLayerWrapper",[n,u])){return;}if(z("video-poplayer-cnt",[n,u])){return;}if(aR.keyCode===39&&o){o.click();OK.stop(aR);}else{if(aR.keyCode===37&&aP){aP.click();OK.stop(aR);}}}}function y(aR){if(aR){OK.Layers.register(ar,function(){S("cr_esc");},undefined,false,x);}else{OK.Layers.remove(ar);}}function ab(aR,aS){OK.loader.use("OKCustomJs",function(){if(aR){y(aS);}if(aS){if(OK.Layers.onLayerShown){OK.Layers.onLayerShown();}}else{if(OK.Layers.onLayerHidden){OK.Layers.onLayerHidden();}}});}function I(){X.toggleClass("__layer",!!aA.isActive);}function aL(){var aR=ao;if(aA.market&&aA.pfMode==""){aR+=" product-layer";}else{aR+=" media-layer__topic";}if(aA.pfJs){aR+=" __posting";}if(aA.isActive){aR+=" __active";}if(aA.isProcess){aR+=" __process";}if(aA.pfMode=="N"){aR+=" __create";}if(aA.pfMode=="E"){aR+=" __edit";}if(aA.hasActiveTopics){aR+=" __has-topics";}if(aA.arrowsHidden){aR+=" __hide-arrows";}if(aA.hasBanner){aR+=" __has-banner";}i.attr("class",aR);}function aw(){ab(true,aA.isActive);I();aL();var aR=ac();if(!aR){return;}var aS=document.getElementById(aR+"Config");if(!aS){return;}var aT=aS.getAttribute("data-slot");if(aA.isActive){i.attr(ae,0);require(["OK/banners/BannerLoader"],function(aU){J=aU.subscribeToEvents(aT,{onAdsSuccess:aF,onNoAds:at,onScriptError:at,onHideBanner:at});});}else{if(J&&typeof J.remove==="function"){J.remove();}aI(aR);aB(false);}}function aF(aR){aB(true);}function at(aR){aB(false);}function aI(aS){var aR=document.getElementById(aS+"Wrapper");if(aR){aR.innerHTML="";}}function aq(aR){var aS=parseInt(i.attr(aR),10);if(isNaN(aS)){aS=0;}return aS;}function m(aR){var aS=aq(aR);i.attr(aR,aS+1);}function E(aS){var aR=aA.isActive!==aS;aA.isActive=aS;if(aR){aw();}else{if(t()){ab(false,true);}}document.getElementById("hook_Block_PopLayerMediaTopic").classList.remove(n);}function am(aR){var aS=aA.isProcess!==aR;aA.isProcess=aR;if(aS){aL();}}function L(aR){var aS=aA.pfMode!==aR;aA.pfMode=aR;if(aS){aL();}}function au(aR){var aS=aA.pfJs!==aR;aA.pfJs=aR;if(aS){aL();}}function aB(aR){if(!aA){return;}var aS=aA.hasBanner!==aR;aA.hasBanner=aR;if(aS){aL();}i.attr(ae,aR?1:0);}function r(aR){F.toggleClass("__process",aR);}function H(aT,aR){var aU=aT.length,aS=aU;while(--aU+1){aT[aU].toggleClass(aR);}setTimeout(function(){while(--aS+1){aT[aS].toggleClass(aR);}},1);}function B(){if(p){var aR=0;aC(".comments_i",p).each(function(){var aS=aC(this).data("unread");if(aS){aR=this.getBoundingClientRect().top;}return !aS;});i.each(function(){this.scrollTop=(aR!==0)?this.scrollTop+aR:this.scrollHeight;});setTimeout(function(){aC(".js-comments_add",p).focus();},50);}}function q(aW,aT,aV){var aS=aC(window),aR=aS.height(),aU=aS.width();if(D.id){clearTimeout(D.id);}D.id=setTimeout(function(){H([v,o,aP,aG],W);D.id=null;},aW?0:D.to);i.toggleClass("__compact",aU<=P);i.toggleClass("__min-height",(aR<al));if(aT){B();}if(aV){ak(aV);}}function s(aR){if(f){return;}f=true;Z=aC(window);X=aC(document.body);i=aC("#"+ar);F=aC("#"+N);aP=aC("#"+ai);o=aC("#"+aM);aG=aC("#"+c);aA={isActive:i.hasClass("__active"),isProcess:i.hasClass("__process"),pfMode:i.hasClass("__edit")?"E":(i.hasClass("__create")?"N":""),pfJs:i.hasClass("__posting"),hasActiveTopics:i.hasClass("__has-topics"),hasBanner:i.hasClass("__has-banner"),arrowsHidden:i.hasClass("__hide-arrows")};w=i.find("."+j);v=w.find("."+af);aO=i.find("."+ay);aO.on("click",function(aS){S("cr_shadow");});v.on("click",function(aS){S("cr_close");});if(aA.isActive){aw();if(!aA.isProcess){q(true,aR);}}if(aR){B();}Z.on("resize.mtLayer",function(){q();});A.resolve(i);}var e;var Y;var aN;function V(aS,aR){if(aR==null||aR.length==0){return;}OK.historyManager.putItemToCache(aS,aR);}function az(aS){if(OK.historyManager.isHistorySupported()){var aT=aS.indexOf("?");if(aT>0){aN=aS.substr(aT+1);Y=aS.substr(0,aT);if(aN.length>0){aN+="&mt.scrollTop="+aC(window).scrollTop();}else{aN=null;}V(Y,aN);}else{Y=aS;aN=null;}var aU=K()==Y&&!T;var aR;if(!e){if(aU){aR=true;}else{if(T){aK(T,true);}}e=K();}else{aR=!aA.closeTopicId;}T="";if(!aU){aK(Y,aR);}}}function G(){if(!e&&Y==K()){aK(e,true);}e=null;Y=null;aN=null;}function K(){return OK.historyManager.getState();}function aK(aS,aR){if(aR){OK.historyManager.replaceState(aS);}else{OK.historyManager.pushState(aS);}}function S(aY,aW){if(aY=="cr_shadow"){if(aA.pfMode!=""){return;}}if(aA.pfMode!=""&&!aW&&(aY==="cr_esc"||aY==="cr_close")){var aX=i.find(".posting");if(aX.length>0){var aR=aX[0].okPosting;if(aR&&aR.needConfirmBeforeClose()){aR.showCloseConfirmDialog();return;}}}a=false;aA.topicId=null;aA.owner=null;var aV=aA.closeTopicId,aS=aA.closeOwnerType;aA.closeTopicId=null;aA.closeOwnerType=null;if(aV&&(aY==="cr_esc"||aY==="cr_shadow"||aY==="cr_close"||aY==="cr_fail")){if(aY){ag(aY+"_ct");}setTimeout(function(){if(OK.historyManager.isHistorySupported()){OK.historyManager.back();}else{ax(aV,aS,"");}},0);return;}var aU=aa();var aT=false;if(aU){if(e&&Y==K()){if(e==Y){aT=true;OK.historyManager.back();}else{aK(e,true);}}}if(!aT){E(false);am(false);L("");r(false);l();an();aG.removeClass("__active __animated");OK.hookModel.setHookContent(M,"");}e=null;if(aY){ag(aY);}i.trigger("mtLayer.close");}function ag(aR){U.success("mtlayer",aD||"",aR);}function l(){aP.removeClass("__active");o.removeClass("__active");}function O(aR,aS){if(aP){aP.toggleClass("__active",!!aR&&!!aS);aP.unbind("click.back").bind("click.back",function(aU){if(aP.hasClass("__active")){var aT=o.hasClass("__active");ax(aR,aS,"MT_GoBack_"+aS,false,"","BACK",aT);}OK.stop(aU);});}}function h(aR,aS){if(o){o.toggleClass("__active",!!aR&&!!aS);o.unbind("click.forward").bind("click.forward",function(aU){if(o.hasClass("__active")){var aT=aP.hasClass("__active");ax(aR,aS,"MT_GoForward_"+aS,false,"","FORWARD",aT);}OK.stop(aU);});}}function ak(aT){if(aT){var aU=i.find("[data-scroll-to='"+aT+"']");if(aU.length>0){var aY=aU[0],aX=aY.offsetTop,aR=aY.offsetParent;while(aR&&aR.nodeType===1&&aR!==i[0]){aX+=aR.offsetTop;aR=aR.offsetParent;}var aW=i,aV=aW.height(),aS=aW.scrollTop(),aZ=aV;if(aS+aV<=aX+aZ){aW.scrollTop(aX+aZ-aV-5);}else{if(aS>aX){aW.scrollTop(aX-5);}}}}}function an(){var aR=X;var aS=aR.find(".gwt-shortcutMenu__show");if(aS.length){aS.removeClass("gwt-shortcutMenu__show");}var aT=aR.find(".sc-menu:not(.sc-menu__hidden,.poll_ans_cnt)");if(aT.length){aT=aT.not("#ownProfileLSMnu");aT.addClass("sc-menu__hidden");}}var aQ=[0,1,2,3,5,8,13,21,34,55,89,144,233,377,610];function av(aS,aU){var aT=(aU-aS)/100;var aR;for(aR=1;aR<aQ.length;aR++){if(aT<aQ[aR]){break;}}return aQ[aR-1]+"00";}function ad(){if(i){i.scrollTop(0);}}function aj(aR){if(aA.isProcess){am(false);}else{r(false);}aR&&aR();}function C(aU,a3,aZ,a5,a6){T=a3;s(aZ);var aT=aC("#"+M);aA.market=aT.attr("data-market")=="true";aA.advertSelectionId=aT.attr("data-adv-sel-id");var a2=aT.attr("data-log");if(a2){ag(a2);}var a0=aT.attr("data-pf-mode");L(a0?a0:false);var aV=aT.attr("data-pf-js");au(aV==="true");var aS=aT.attr("data-url");if(aS){az(aS);}else{G();}if(aA.closeTopicId||a5){}else{var aY=aT.attr("data-back-id");O(aY,aU);var aX=aT.attr("data-forward-id");h(aX,aU);}var a4=aT.attr("data-id");if(a4){aA.topicId=a4;aA.owner=aU;}var aR=aT.attr("data-log-click");if(aR){i.attr("data-l",aR);}else{i.removeAttr("data-l");}var aW=w.find("."+Q);if(aW.length>0){var a7=function(bb){var ba=bb.delegateTarget.getAttribute("data-url");var a8=bb.delegateTarget.getAttribute("uid");if(ba){if(a8){var a9=aC.ajax({type:"POST",url:ba,data:{"gwt.requested":window.pageCtx.gwtHash},headers:{TKN:OK.tkn.get()}});a9.done(function(bc,be,bd){aW.children().unbind("click.advert");R("PLAdvertStatusBackToView",function(){w.find("."+Q).children().bind("click.advert",a7);});});}else{window.navigateOnUrlFromJS(ba);}}OK.stop(bb);};aW.children().bind("click.advert",a7);}if(!aA.isProcess){aL();}aj(a6);H([o,aP,aG],W);ad();p=w.find("."+ap);b=w.find("."+d);var a1=aT.attr("data-scroll-to-marker");q(true,aZ,a1);}function ac(){if(document.getElementById("hook_Block_"+aJ)){return aJ;}if(document.getElementById("hook_Block_"+k)){return k;}return null;}function aH(aW){var aU=ac();var aT=aU&&aA.isActive;if(!aT){return false;}if(aW){var aV=document.getElementById(aU+"Config");if(aV){var aS=aV.getAttribute("data-everyNDisplay");if(aS){var aR=aq(ae);if(aR===0){return true;}return(aR%aS)===0;}}}return true;}function ax(a1,aR,a5,aZ,a6,a8,aT,a7,a2,aU,aS,a0){var a4=Date.now();var aX;s(aZ);if(!a8){aA.closeTopicId=null;aA.closeOwnerType=null;}if(a5&&a5.indexOf("st.mt.or=on")!==-1){a2=aA.topicId;aU=aA.owner;}if(OK.photoLayer){OK.photoLayer.close();}OK.VideoPlayer.pauseAll();OK.loader.use("OKCustomJs",function(){var a9=OK.Layers.stack;var ba=a9&&a9.length>0&&a9[a9.length-1].id===ar;if(!ba&&aA.isActive){y(true);}});function a3(bc){var bb=Date.now();var a9="";if(bc){a9+="r_";}if(a8){a9+="dt";}else{a9+="ot";}ag(a9+av(a4,bb));if(aX){ag("js_"+a9+av(aX,bb));}if(aA.pfMode){var ba=bb-a4;if(ba>0){U.duration("mtlayer",bb-a4,(aD||"")+"."+aA.pfMode,(aA.pfJs?"js":"gwt"));}else{U.duration("mtlayer",bb-a4,(aD||"")+"."+aA.pfMode,(aA.pfJs?"js":"gwt")+"_wtf");}}}aD=aR;T=a6;if(T){ag("shortlink");}l();if(aA.isActive&&!aA.isProcess){r(true);an();}else{am(true);}E(true);var aY;if(OK.getCurrentStateLink){aY=OK.getCurrentStateLink();}else{aY="/dk?"+window.pageCtx.state.replace("&amp;","&");}aY+=aY.indexOf("?")===-1?"?":"&";aY=aY.replace(/st\.mt\.(id|ot|bi|dir|hn).*?(&|$)/g,"");aY+="cmd="+M;if(a5){aY+="&st._aid="+a5;}var aW=aH(!!a8);var aV=aC.ajax({type:"POST",url:aY,data:{"gwt.requested":window.pageCtx.gwtHash,"st.mt.id":a1,"st.mt.ot":aR,"st.mt.dir":a8,"st.mt.wc":a7?"on":"off","st.mt.hn":aS?"on":"off","st.mt.ad":aW?"on":"off","st.mt.bi":a0?a0:0,"st.mt.as":aA.advertSelectionId},headers:{TKN:OK.tkn.get()}});aV.done(function(bd,bb,bk){aX=Date.now();if(a2){aA.closeTopicId=a2;aA.closeOwnerType=aU;}var bg=bk.getResponseHeader("Redirect-Location");if(bg){var bh=function(bl){if(OK.navigation.redirect){OK.navigation.redirect(bg);}if(bl===0||OK.navigation.redirect){S();a3();}else{setTimeout(function(){bh(bl-1);},200);}};bh(5);}else{var be=bk.getResponseHeader("End-Reached");if(be==="yes"){if(a8==="FORWARD"){if(aT){aP.toggleClass("__active",true);}}else{if(a8=="BACK"){if(aT){o.toggleClass("__active",true);}}}aj(a3);return;}var bf=bd.split(OK.navigation.SPLITER),bi=bk.getResponseHeader(OK.navigation.HEADER).split(",");var bj;for(var bc=0;bc<bf.length;bc++){var ba=bi[bc];if(ba){var a9=bf[bc];OK.hookModel.setHookContent(ba,a9);if(ba===aJ||ba===k){bj=a9;}}}g(bj,a8);C(aR,T,aZ,aS,a3);}});aV.fail(function(){S("cr_fail");a3();});return aV;}function g(aU,aT){if(aU){var aR=document.createElement("div");aR.innerHTML=aU;if(aR.getElementsByClassName("media-layer_ads").length===0){aB(false);}}else{var aS=document.getElementById(M);if(aS.getAttribute("data-hide-ad")==="true"){aI(ac());aB(false);}else{if(aT&&aA.hasBanner){m(ae);}}}}function R(aU,aV){function aR(){if(aV){aV();}}if(!aA||!aA.topicId||!aA.owner){aR();return;}var aS="/";if(OK.getCurrentStateLink){aS=OK.getCurrentStateLink();}aS+=aS.indexOf("?")===-1?"?":"&";aS+="cmd="+M+"&st._aid="+aU;var aT=aC.ajax({type:"POST",url:aS,data:{"gwt.requested":window.pageCtx.gwtHash,"st.mt.id":aA.topicId,"st.mt.ot":aA.owner},headers:{TKN:OK.tkn.get()}});aT.done(function(a0,a2,a1){var aX=a1.getResponseHeader("Redirect-Location");if(aX){if(OK.navigation.redirect){OK.navigation.redirect(aX);}S();}else{var aW=a0.split(OK.navigation.SPLITER),aZ=a1.getResponseHeader(OK.navigation.HEADER).split(",");for(var aY=0;aY<aW.length;aY++){if(aZ[aY]){OK.hookModel.setHookContent(aZ[aY],aW[aY]);}}}aR();});aT.fail(aR);}return{show:function(){s();E(true);ad();},showPreloaded:C,showTopicInLayer:ax,closeLayer:function(aS,aR){if(f){S(aS,aR);}},hideLayer:function(){a=false;if(aA&&aA.isActive){if(e&&K()==Y){aK(e,true);}ab(false,false);}},restoreLayer:function(){if(aA&&aA.isActive){H([v,o,aP,aG],W);if(e&&K()!==Y){aK(Y,true);}ab(false,true);}},refreshLayerBody:function(aR){R("PLPhotoUserBackToView",aR);},deactivate:function(){aC(window).off(".mtLayer");if(v){v.off();}if(aO){aO.off();}E(false);},updateActiveTopics:function(aT,aR,aS){A.promise.then(function(aU){aA.hasActiveTopics=aR;aA.arrowsHidden=aS;var aW=aT.getHeight();var aV=F.outerHeight(true);if(aR){if(aV<aW){F.css("min-height",aW);}else{if(aV-aW<100){aT.setHeight(aV);}}}else{F.css("min-height","");}aL();});}};});